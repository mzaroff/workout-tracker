<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workout Parser</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f9f9f9;
    }
    textarea {
      width: 100%;
      height: 200px;
      font-size: 1rem;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    button {
      margin-top: 1rem;
      margin-right: 1rem;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      background: #007bff;
      color: white;
    }
    pre {
      background: #eee;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>Workout Parser</h1>
  <p>Paste your trainer's message below:</p>
  <textarea id="workoutText" placeholder="Paste workout text here..."></textarea>
  <br>
  <button onclick="parseWorkout()">Generate Workout JSON</button>
  <button onclick="downloadJSON()">Download JSON</button>
  <pre id="jsonOutput"></pre>

  <script>
    let latestJSON = null;

    function parseWorkout() {
      const text = document.getElementById('workoutText').value;
      const lines = text.split('\n').filter(line => line.trim());
      const exercises = [];
      let workout_id = "preview";
      let last_updated = new Date().toISOString().split('T')[0];

      lines.forEach((line, index) => {
        const raw = line.trim();

        if (/Workout\s*\d+/i.test(raw)) {
          const idMatch = raw.match(/Workout\s*(\d+)/i);
          if (idMatch) workout_id = `Workout ${idMatch[1]}`;
          return;
        }

        if (/Update\s*[:\-]\s*/i.test(raw)) {
          const dateMatch = raw.match(/Update\s*[:\-]\s*(\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4})/);
          if (dateMatch) last_updated = dateMatch[1];
          return;
        }

        const exercise = {};
        exercise.raw = raw;

        const machineMatch = raw.match(/#(\d+)/);
        if (machineMatch) {
          exercise.machine_id = parseInt(machineMatch[1]);
        }

        const adjustmentMatch = raw.match(/adj#\d+(?:\/\d+)?/i);
        if (adjustmentMatch) {
          exercise.adjustment = adjustmentMatch[0];
        }

        const nameMatch = raw.match(/^#?\d*:?\s*([^:]+):/);
        if (nameMatch) {
          exercise.name = nameMatch[1].trim();
        } else {
          const fallback = raw.split(":")[0];
          exercise.name = fallback.trim();
        }

        const setPattern = /(\d+)\s*sets?\s*x\s*(\d+)(?:-(\d+))?(?:\s*\((\d+)\))?\s*(reps|sec)?\s*x\s*([\d.]+\s*lbs|Bodyweight)/gi;
        const sets = [];
        let match;
        let setCounter = 1;
        while ((match = setPattern.exec(raw)) !== null) {
          const setCount = parseInt(match[1]);
          const repBase = match[2];
          const repRange = match[3];
          const maxRep = match[4];
          const unit = match[5]?.toLowerCase();
          const weight = match[6];

          let reps = repBase;
          if (repRange) {
            reps = `${repBase}-${repRange}`;
          } else if (!repRange && maxRep) {
            reps = `${repBase}-${maxRep}`;
          }

          for (let i = 0; i < setCount; i++) {
            const set = { set: setCounter++, weight: weight };
            set.reps = reps;
            if (maxRep && repRange) set.max_reps = parseInt(maxRep);
            sets.push(set);
          }
        }
        if (sets.length > 0) {
          exercise.sets = sets;
        }

        const simpleSet = raw.match(/(\d+)\s*sets?\s*x\s*\((\d+)\)\s*(reps|sec)?\s*x\s*([\d.]+\s*lbs|Bodyweight)/i);
        if (!exercise.sets && simpleSet) {
          exercise.sets = [
            {
              set: 1,
              reps: `${simpleSet[2]}-${simpleSet[2]}`,
              max_reps: parseInt(simpleSet[2]),
              weight: simpleSet[4]
            }
          ];
        }

        const repairSet = raw.match(/(\d+)\s*sets?\s*x\s*(\d+)\s*lbs/i);
        if (!exercise.sets && repairSet) {
          exercise.sets = [
            {
              set: 1,
              reps: 0,
              weight: `${repairSet[2]} lbs`
            }
          ];
        }

        const restMatch = raw.match(/(\d+\s*(sec|min))\s*rest/i);
        if (restMatch) {
          exercise.rest = restMatch[1];
        }

        const noteMatch = raw.match(/\(([^)]{10,})\)$/);
        if (noteMatch) {
          exercise.notes = noteMatch[1].trim();
        }

        exercises.push(exercise);
      });

      const result = {
        workout_id,
        last_updated,
        exercises
      };

      latestJSON = result;
      document.getElementById('jsonOutput').textContent = JSON.stringify(result, null, 2);
    }

    function downloadJSON() {
      if (!latestJSON) return;
      const filename = latestJSON.workout_id?.replace(/\s+/g, '_').toLowerCase() || 'workout';
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(latestJSON, null, 2));
      const downloadAnchor = document.createElement('a');
      downloadAnchor.setAttribute("href", dataStr);
      downloadAnchor.setAttribute("download", `${filename}.json`);
      document.body.appendChild(downloadAnchor);
      downloadAnchor.click();
      downloadAnchor.remove();
    }
  </script>
</body>
</html>
